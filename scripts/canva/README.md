# Canva Integration - Quick Reference

Quick reference for Canva Connect API integration in aiCMO newsletter system.

## Quick Start

### 1. First-Time Setup

```bash
# 1. Get credentials from https://www.canva.com/developers/
# 2. Add to .env file:
#    CANVA_CLIENT_ID=your-client-id
#    CANVA_CLIENT_SECRET=your-client-secret
#    CANVA_REDIRECT_URI=http://localhost:3001/oauth/redirect

# 3. Install dependencies
npm install

# 4. Authenticate with Canva
node scripts/canva/canva-oauth.js
```

### 2. Generate Newsletter Images

```bash
node scripts/newsletter/generate-images-canva.js campaigns/weekly-newsletter/issue-01/issue-01-newsletter.md
```

## Files Overview

| File | Purpose |
|------|---------|
| `canva-oauth.js` | OAuth authentication helper - handles token management |
| `generate-images-canva.js` | Newsletter image generation script |
| `.canva-tokens.json` | OAuth tokens storage (auto-generated, do not commit) |

## Common Commands

### Authentication

```bash
# Run OAuth flow (first time or if tokens expired)
node scripts/canva/canva-oauth.js

# Tokens are saved to .canva-tokens.json automatically
# Subsequent runs will reuse cached tokens
```

### Image Generation

```bash
# Generate images for a specific newsletter
node scripts/newsletter/generate-images-canva.js <newsletter-path>

# Example
node scripts/newsletter/generate-images-canva.js campaigns/weekly-newsletter/issue-01/issue-01-newsletter.md
```

## How It Works

### OAuth Flow (Automatic)

```
1. Run canva-oauth.js
   ↓
2. Opens browser → Canva authorization page
   ↓
3. User clicks "Authorize"
   ↓
4. Redirect to localhost:3001/oauth/redirect
   ↓
5. Exchange code for access token
   ↓
6. Save tokens to .canva-tokens.json
   ↓
7. ✅ Ready to use API
```

### Token Management (Automatic)

```
Load cached tokens
   ↓
Check if expired?
   ├─ No → Use cached token
   └─ Yes → Refresh token
       ↓
   Refresh successful?
       ├─ Yes → Use new token
       └─ No → Run OAuth flow again
```

### Design Creation Workflow

```
1. Parse newsletter content
   ↓
2. Authenticate (automatic token handling)
   ↓
3. Create blank design via API
   ↓
4. Open design URL in browser
   ↓
5. Customize design in Canva UI
   ↓
6. Export as PNG via API (optional)
   ↓
7. Download to assets/ folder
```

## Redirect URL Configuration

### Development (localhost)
✅ Allowed by Canva for testing
```
http://localhost:3001/oauth/redirect
```

### Production (public domain)
⚠️ Required for deployed applications
```
https://yourdomain.com/oauth/redirect
```

**Important:** Canva requires at least one **non-localhost** URL to be set as the default redirect URL, but you can add localhost URLs for development.

## Environment Variables

```bash
# Required
CANVA_CLIENT_ID=your-client-id              # From Developer Portal
CANVA_CLIENT_SECRET=your-client-secret      # From Developer Portal

# Optional (defaults to localhost:3001)
CANVA_REDIRECT_URI=http://localhost:3001/oauth/redirect
```

## API Scopes

The integration requires these scopes:

- `design:content:read` - Read design content
- `design:content:write` - Create/modify designs
- `design:meta:read` - Read design metadata
- `asset:read` - Read assets
- `asset:write` - Upload assets
- `profile:read` - Read user profile

## Token Storage

### .canva-tokens.json Format

```json
{
  "access_token": "eyJhbGc...",
  "refresh_token": "def502...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "timestamp": "2025-10-13T10:30:00.000Z",
  "expiresAt": "2025-10-13T11:30:00.000Z"
}
```

**Security:**
- ✅ Auto-generated by authentication script
- ✅ Stored locally (not committed to git)
- ✅ Auto-refreshed when expired
- ❌ Never commit this file
- ❌ Never share access tokens

## Troubleshooting

### "Missing Canva credentials"
→ Add `CANVA_CLIENT_ID` and `CANVA_CLIENT_SECRET` to `.env`

### "Redirect URI mismatch"
→ Add `http://localhost:3001/oauth/redirect` in Canva Developer Portal

### "Token expired"
→ Script automatically refreshes tokens (no action needed)

### "State mismatch"
→ Clear browser cache and run OAuth flow again

### "Browser doesn't open"
→ Copy authorization URL from terminal and open manually

## API Limitations

### Current Capabilities
✅ Create blank designs programmatically
✅ Export designs as PNG/JPG/PDF
✅ Upload images to Canva
✅ List user's designs
✅ Read design metadata

### Current Limitations
❌ Cannot add text/elements via API (requires Canva UI)
❌ Cannot apply templates programmatically
❌ Manual customization still required
❌ No bulk design generation

**Recommended Workflow:**
1. Create design via API (blank canvas)
2. Open in Canva UI to customize
3. Export via API when ready

## Useful Links

- **Developer Portal:** https://www.canva.com/developers/
- **Full Setup Guide:** See [CANVA_SETUP.md](../../CANVA_SETUP.md) in project root
- **API Docs:** https://www.canva.dev/docs/connect/
- **API Status:** https://status.canva.com

## Examples

### Example 1: Simple Authentication

```javascript
import { getAccessToken } from './canva-oauth.js';

// Get access token (handles OAuth flow if needed)
const token = await getAccessToken();
console.log('Authenticated!');
```

### Example 2: Create a Design

```javascript
import { getAccessToken } from './canva-oauth.js';
import { createDesign } from '../newsletter/generate-images-canva.js';

const token = await getAccessToken();

const design = await createDesign(
  token,
  'Newsletter Header',
  'Presentation',
  600,  // width
  200   // height
);

console.log(`Edit design: https://www.canva.com/design/${design.id}/edit`);
```

### Example 3: List Recent Designs

```javascript
import { getAccessToken } from './canva-oauth.js';
import { listDesigns } from '../newsletter/generate-images-canva.js';

const token = await getAccessToken();
const designs = await listDesigns(token, 10);

designs.forEach(d => console.log(`${d.title} - ${d.id}`));
```

## Next Steps

1. ✅ Complete setup: Follow [CANVA_SETUP.md](../../CANVA_SETUP.md)
2. ✅ Run authentication: `node scripts/canva/canva-oauth.js`
3. ✅ Test integration: Generate images for Issue #1
4. ✅ Create design templates in Canva UI
5. ✅ Integrate with newsletter workflow

---

**Last Updated:** 2025-10-13
